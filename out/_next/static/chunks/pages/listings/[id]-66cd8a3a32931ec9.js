(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[748],{6954:function(e,s,n){(window.__NEXT_P=window.__NEXT_P||[]).push(["/listings/[id]",function(){return n(5591)}])},2021:function(e,s,n){"use strict";n.d(s,{Z:function(){return d}});var i=n(5893),a=n(1664),t=n.n(a),l=n(1163),r=n(4611);let c=[{href:"/",label:"首页"},{href:"/publish",label:"发布"},{href:"/search",label:"智能搜索"},{href:"/recharge",label:"积分充值"},{href:"/me",label:"个人中心"}];function d(e){var s,n,a;let{children:d}=e,o=(0,l.useRouter)(),{user:h,logout:u}=(0,r.a)(),m=e=>"/"===e?"/"===o.pathname:o.pathname===e||o.pathname.startsWith("".concat(e,"/"));return(0,i.jsxs)("div",{style:{padding:"0 20px"},children:[(0,i.jsxs)("header",{className:"app-header",children:[(0,i.jsxs)("div",{children:[(0,i.jsx)("div",{className:"app-brand",children:"C2C 情报局"}),(0,i.jsx)("div",{style:{fontSize:12,color:"var(--muted)"},children:"72 小时自动下架 \xb7 智能风控撮合 \xb7 Supabase 实时底座"})]}),(0,i.jsx)("nav",{className:"app-nav",children:c.map(e=>(0,i.jsx)(t(),{href:e.href,className:m(e.href)?"active":void 0,children:e.label},e.href))}),(0,i.jsx)("div",{className:"user-chip",children:h?(0,i.jsxs)(i.Fragment,{children:[(0,i.jsxs)("div",{children:[(0,i.jsx)("div",{style:{fontWeight:600},children:null!==(s=h.phone)&&void 0!==s?s:"未绑定手机"}),(0,i.jsxs)("div",{style:{fontSize:12,color:"var(--muted)"},children:["微信：",null!==(n=h.wechat)&&void 0!==n?n:"未设置"," \xb7 积分 ",null!==(a=h.points)&&void 0!==a?a:0]})]}),(0,i.jsx)("button",{className:"secondary-btn",onClick:u,children:"退出"})]}):(0,i.jsx)(t(),{className:"primary-btn",href:"/auth/login",children:"登录 / 入驻"})})]}),(0,i.jsx)("main",{style:{maxWidth:1200,margin:"0 auto 60px",padding:"0 8px"},children:d})]})}},971:function(e,s,n){"use strict";n.d(s,{F:function(){return a}});var i=n(5893);function a(e){let{message:s}=e;return s?(0,i.jsx)("div",{className:"toast",children:s}):null}},7996:function(e,s,n){"use strict";n.d(s,{p:function(){return a}});var i=n(7294);function a(){let[e,s]=(0,i.useState)(null);return{message:e,show:(0,i.useCallback)(e=>{s(e),window.setTimeout(()=>s(null),2500)},[])}}},5591:function(e,s,n){"use strict";n.r(s),n.d(s,{default:function(){return o}});var i=n(5893),a=n(1163),t=n(7294),l=n(2021),r=n(4611),c=n(971),d=n(7996);function o(){var e;let{id:s}=(0,a.useRouter)().query,{tokens:n,user:o}=(0,r.a)(),{message:h,show:u}=(0,d.p)(),[m,p]=(0,t.useState)(null),[j,x]=(0,t.useState)(!0),[f,v]=(0,t.useState)(null);(0,t.useEffect)(()=>{"string"==typeof s&&(x(!0),fetch("/api/listings/".concat(s)).then(e=>e.json()).then(e=>{var s;return p(null!==(s=e.data)&&void 0!==s?s:null)}).finally(()=>x(!1)))},[s]);let N=async()=>{if(m){if(!n){u("请先登录再解锁联系方式");return}try{let s=await fetch("/api/contact",{method:"POST",headers:{"Content-Type":"application/json",Authorization:"Bearer ".concat(n.accessToken)},body:JSON.stringify({postId:m.id})}),i=await s.json();if(!s.ok){var e;throw Error(null!==(e=i.error)&&void 0!==e?e:"解锁失败")}v({contact:i.data.contact,token:i.data.contactToken,deadline:i.data.confirmDeadline}),u("已解锁微信：".concat(i.data.contact))}catch(e){u(e.message)}}},g=async()=>{if(!m)return;if(!n||(null==o?void 0:o.id)!==m.userId){u("仅发布者可重新上架");return}let e=await fetch("/api/listings/".concat(m.id),{method:"POST",headers:{"Content-Type":"application/json",Authorization:"Bearer ".concat(n.accessToken)},body:JSON.stringify({action:"republish"})}),s=await e.json();if(!e.ok){var i;u(null!==(i=s.error)&&void 0!==i?i:"刷新失败");return}p(s.data),u("已重新上架并刷新剩余查看次数")};return(0,i.jsxs)(l.Z,{children:[(0,i.jsxs)("div",{className:"page-section",children:[j&&(0,i.jsx)("p",{children:"正在加载数据..."}),!j&&!m&&(0,i.jsx)("p",{children:"该信息已下架或不存在。"}),!j&&m&&(0,i.jsxs)(i.Fragment,{children:[(0,i.jsxs)("div",{className:"meta-row",children:[(0,i.jsx)("span",{className:"chip",children:"sell"===m.tradeType?"出售":"buy"===m.tradeType?"求购":"其他"}),(0,i.jsx)("span",{className:"chip emphasis",children:"active"===m.status?"在售":"已下架"})]}),(0,i.jsx)("h1",{style:{marginTop:12},children:m.title}),(0,i.jsx)("p",{style:{color:"var(--muted)",fontSize:16},children:m.description}),(0,i.jsxs)("div",{className:"meta-row",style:{marginTop:12},children:[(0,i.jsxs)("span",{className:"badge",children:[(0,i.jsx)("strong",{children:"价格"})," \xa5",m.price]}),(0,i.jsxs)("span",{className:"badge",children:["剩余 ",m.remainingViews,"/",m.viewLimit," 次查看"]}),(0,i.jsxs)("span",{className:"badge",children:["成交 ",null!==(e=m.totalDeals)&&void 0!==e?e:0," 次"]})]}),(0,i.jsxs)("div",{className:"list-card-actions",style:{marginTop:18},children:[(0,i.jsx)("button",{className:"primary-btn",onClick:N,disabled:!n||"active"!==m.status,children:"解锁微信"}),(null==o?void 0:o.id)===m.userId&&(0,i.jsx)("button",{className:"secondary-btn",onClick:g,children:"重新上架"})]}),f&&(0,i.jsxs)("div",{className:"contact-card",style:{marginTop:24},children:[(0,i.jsx)("div",{style:{fontSize:13,color:"#0369a1"},children:"已解锁微信号"}),(0,i.jsx)("div",{style:{fontSize:28,fontWeight:700},children:f.contact}),(0,i.jsxs)("p",{style:{margin:"8px 0",fontSize:13,color:"var(--muted)"},children:["凭证 ",f.token," \xb7 请在 ",new Date(f.deadline).toLocaleString()," 前完成成交确认"]})]}),(0,i.jsxs)("div",{className:"timeline",style:{marginTop:32},children:[(0,i.jsxs)("div",{className:"timeline-item",children:[(0,i.jsx)("div",{className:"timeline-dot"}),(0,i.jsxs)("div",{children:[(0,i.jsx)("strong",{children:"步骤 1 \xb7 解锁微信"}),(0,i.jsx)("p",{className:"form-note",children:"每次扣除 1 积分，自动记录到积分流水中，管理员可回溯。"})]})]}),(0,i.jsxs)("div",{className:"timeline-item",children:[(0,i.jsx)("div",{className:"timeline-dot"}),(0,i.jsxs)("div",{children:[(0,i.jsx)("strong",{children:"步骤 2 \xb7 24 小时跟进"}),(0,i.jsx)("p",{className:"form-note",children:"系统会在 24 小时内提醒买家回传成交截图，超时自动顺延。"})]})]}),(0,i.jsxs)("div",{className:"timeline-item",children:[(0,i.jsx)("div",{className:"timeline-dot"}),(0,i.jsxs)("div",{children:[(0,i.jsx)("strong",{children:"步骤 3 \xb7 成交回执"}),(0,i.jsx)("p",{className:"form-note",children:"提交截图后，成交次数 +1，卖家积分同步增加。"})]})]})]})]})]}),(0,i.jsx)(c.F,{message:h})]})}}},function(e){e.O(0,[424,888,774,179],function(){return e(e.s=6954)}),_N_E=e.O()}]);