# Requirements Document

## Introduction
智能供需信息撮合平台旨在连接高需求的二手3C买卖双方，通过强制微信+手机号双因子认证、积分驱动的联系方式售卖以及AI辅助的结构化表单，提供高可信、高效率的匹配体验。本次需求聚焦于基础用户闭环（注册、发帖、查看、成交）、强化搜索与成交反馈能力，并确保积分充值能够被运营及时处理。

## Alignment with Product Vision
平台愿景是打造“高匹配、高信任、快响应”的移动优先C2C信息流。本次功能确保：1）入口即可信——微信+手机号绑定杜绝刷号；2）交易链路自洽——积分与联系人的交换透明、可追踪；3）效率可衡量——以累计成交次数替换成交率，提供可验证的信誉指标；4）智能辅助——借助DeepSeek模型降低发帖成本，后台人工只需处理例外；5）运营可控——人工审核充值并收到即时提醒，保证现金流安全。

## Requirements

### Requirement 1 — 微信+手机号双因子注册登录

**User Story:** 作为首次使用的卖家，我希望通过微信授权并绑定手机号完成注册登录，以确保账号可信度并避免重复认证。

#### Acceptance Criteria
1. WHEN 用户点击注册 THEN 系统 SHALL 先发起微信OAuth授权并校验state/nonce。
2. IF 微信授权成功 AND 用户输入手机号与短信码有效 THEN 系统 SHALL 绑定openid+手机号并颁发30天有效JWT。
3. WHEN 用户尝试发帖 BUT 未完成手机号或微信任一绑定 THEN 系统 SHALL 阻止操作并提示“完成双重绑定后继续”。

### Requirement 2 — 发布信息与联系方式售卖闭环

**User Story:** 作为卖家，我要发布需求/供给信息并通过出售联系方式换取积分，以便覆盖获客成本。

#### Acceptance Criteria
1. WHEN 卖家提交表单 THEN 系统 SHALL 校验必填字段并在成功后扣除10积分、初始化10次联系方式查看额度、设置72小时有效期。
2. WHEN 买家支付1积分查看联系方式 THEN 系统 SHALL 扣分成功后自动复制卖家的微信号到剪贴板并提示“复制成功，如失败可重试”。
3. IF 信息已过期 OR 查看额度耗尽 THEN 系统 SHALL 将状态标记为“已下架”并不再允许购买联系方式。

### Requirement 3 — 累计成交次数记录与展示

**User Story:** 作为买家，我希望看到某条信息和发布者的累计成交次数，从而快速判断其可靠度。

#### Acceptance Criteria
1. WHEN 买家在24小时内反馈“已成交” AND 至少上传文本/截图说明 THEN 系统 SHALL 为该信息与发布者各自的累计成交次数+1。
2. WHEN 列表/详情/个人主页渲染 THEN 系统 SHALL 显示“成交次数：X次”并展示最近三次成交时间（若存在）。
3. IF 用户连续三次查看后未反馈成交 THEN 系统 SHALL 发送提醒通知并在后台生成待跟进记录。

### Requirement 4 — 搜索与发现增强

**User Story:** 作为高频买家，我想通过模糊、拼音首字母和历史搜索快速找到相关信息。

#### Acceptance Criteria
1. WHEN 用户输入关键词 THEN 系统 SHALL 同时执行精准匹配、模糊匹配、拼音首字母匹配并按综合评分排序结果。
2. WHEN 用户完成一次搜索 THEN 系统 SHALL 将词条写入其本地与云端历史（最多10条）并支持一键清除。
3. IF 后台配置热门搜索 OR AI 给出推荐 THEN 系统 SHALL 在输入框聚焦时展示建议词，点击后自动发起搜索。

### Requirement 5 — 人工充值及后台提醒

**User Story:** 作为运营人员，我需要实时看到新的充值请求并在审核后发放积分，避免用户久等。

#### Acceptance Criteria
1. WHEN 用户提交充值金额与凭证 THEN 系统 SHALL 创建“待审核”记录并向后台提醒池推送红点/消息。
2. WHEN 管理员审核通过 THEN 系统 SHALL 写入积分变动、记录操作人/时间/备注，并通知用户到账。
3. IF 充值记录在30分钟仍未处理 THEN 系统 SHALL 触发二次提醒并记录在运营报表中。

### Requirement 6 — DeepSeek驱动的AI表单辅助

**User Story:** 作为卖家，我希望系统从我输入的自然语言中自动提取关键词、价格和类目，减少手动填写。

#### Acceptance Criteria
1. WHEN 用户输入标题/描述 THEN 系统 SHALL 调用DeepSeek API（超时1.5s，最大重试2次）返回结构化建议，失败时提示“手动填写”。
2. IF AI 提取出疑似微信号/外部链接 THEN 系统 SHALL 标记风险并交由后台审核确认。
3. WHEN 用户保存表单 THEN 系统 SHALL 将AI建议与用户最终选择共同写入audit log以便追溯。

## Non-Functional Requirements

### Code Architecture and Modularity
- 认证、积分、搜索、AI网关各自为独立服务/模块，严格单一职责。
- 通过接口契约（API schema/TypeScript接口）隔离前后端，并复用统一的DTO。
- 所有共享逻辑（如累计成交统计、通知）以领域服务形式暴露，避免重复实现。

### Performance
- 关键API（登录、发布、搜索、购买联系方式）P95 < 200ms，搜索最多返回20条/页。
- DeepSeek调用需设置1.5s超时+最多2次重试，整体提交表单体验控制在3s内。
- 后台充值提醒从用户提交到后台看见≤5s。

### Security
- 微信OAuth流程必须验证state/nonce并绑定唯一openid，JWT存储设备指纹。
- 敏感字段（微信号、凭证）在存储前AES加密，日志使用脱敏形式。
- 所有积分写操作必须经过幂等控制并落双写日志，防止重放。

### Reliability
- 自动复制流程失败需提供重试按钮并记录失败率；若连续失败>3%，触发告警。
- 充值提醒队列采用至少一次投递，并在后台页面显示滞留时长。
- 发布、购买、成交计数等关键操作需具备事务保障，避免积分/累计次数错乱。

### Usability
- 全流程移动优先，控件尺寸≥48px，主要信息字号≥16px。
- 重要节点（绑定失败、积分不足、提醒）使用易懂文案和Toast/弹窗双重提示。
- 搜索历史对用户可控（展示/删除），并支持暗色模式的对比度要求。
