{
  "id": "snapshot_1763550191592_wbhn1h3qe",
  "approvalId": "approval_1763548906987_53t1199b2",
  "approvalTitle": "Design: c2c-info-marketplace",
  "version": 2,
  "timestamp": "2025-11-19T11:03:11.592Z",
  "trigger": "approved",
  "status": "pending",
  "content": "﻿# Design Document\r\n\r\n## Overview\r\n该设计面向智能供需信息撮合平台的 MVP，实现“微信+手机号双因子认证 → 发布/购买联系方式 → 累计成交反馈 → 搜索增强 → 人工充值提醒 → DeepSeek AI 辅助”完整闭环。前端为移动优先 H5 + 管理后台，后端按领域拆分 Auth、Listing、Deal、Search、Points、AI Gateway 六个服务，统一经 API Gateway 暴露。所有写操作均通过事件总线（Kafka/Redis Stream）记录审计，积分/成交采用分布式事务（本地事务+Outbox）确保一致性。\r\n\r\n## Steering Document Alignment\r\n\r\n### Technical Standards (tech.md)\r\n- 后端遵循“微服务 + REST + JWT”的标准，服务以 NestJS / Spring Boot 风格实现，日志/监控结构遵循 tech.md 要求（JSON 日志、Prometheus 指标）。\r\n- 鉴权流程按 tech 标准使用 OAuth 2.0 + JWT，所有敏感字段 AES 加密后存储，与PRD一致。\r\n- 深度调用外部AI走独立 Gateway，符合 tech.md 对第三方集成“隔离+熔断”的规范。\r\n\r\n### Project Structure (structure.md)\r\n- 仓库按 `/apps/frontend`, `/apps/admin`, `/services/*`, `/shared` 组织；设计中所有模块沿用该分层：\r\n  - `/services/auth` 负责微信+手机号绑定、JWT颁发。\r\n  - `/services/listing` 覆盖发布、自动复制、有效期控制。\r\n  - `/services/deal` 负责累计成交统计与提醒。\r\n  - `/services/search` 提供统一搜索API（模糊/拼音/历史）。\r\n  - `/services/points` 管理积分账本和充值提醒。\r\n  - `/services/ai-gateway` 统一封装 DeepSeek API。\r\n  - `/shared` 提供DTO、事件定义、加密工具。\r\n\r\n## Code Reuse Analysis\r\n\r\n### Existing Components to Leverage\r\n- **Auth 模块**：复用现有 JWT 颁发和短信验证码逻辑，只需扩展微信 OAuth 流程和双因子检查。\r\n- **积分账本 (Points Ledger)**：沿用现有记账+流水模型，扩展新的交易类型（发布、查看、重新上架、充值人工确认）。\r\n- **通知中心**：接入已有 Toast/站内信/企业微信机器人发送能力，用于提醒积分不足、充值待审、成交反馈。\r\n- **列表组件**：前端复用现有卡片组件，额外增加“成交次数”字段。\r\n\r\n### Integration Points\r\n- **用户服务**：读取并更新 `users.wechat_openid / phone / total_deals`，需添加唯一性索引与设备指纹字段。\r\n- **帖子服务**：`posts` 表增加 `total_deals`、`view_limit` 等字段；和 Deal 服务通过事件同步。\r\n- **搜索引擎**：ES / Meilisearch 索引结构中新增 `total_deals`、`remaining_views`，并支持拼音分词器。\r\n- **AI Gateway**：封装 DeepSeek API Key，暴露 `POST /ai/extract-listing`，返回标准 DTO，供 Listing 服务使用。\r\n\r\n## Architecture\r\n\r\n整体架构：\r\n1. **前端层**：移动端 H5 + 管理后台，调用 BFF/API Gateway。\r\n2. **服务层**：Auth、Listing、Deal、Search、Points、AI Gateway 各自自治，通过 gRPC/REST 通讯。\r\n3. **数据层**：MySQL (主)，Redis (Session/Throttle)，ElasticSearch (搜索)，Kafka/Redis Stream (事件总线)。\r\n\r\n### 模块关系（例）\r\n```mermaid\r\nflowchart LR\r\n    FE_H5 -->|REST| BFF -->|JWT| AuthSvc\r\n    BFF --> ListingSvc --> PointsSvc\r\n    ListingSvc -->|event:ListingPublished| DealSvc\r\n    BFF --> SearchSvc\r\n    ListingSvc --> AI_Gateway\r\n    PointsSvc --> AdminFE\r\n    DealSvc --> NotificationSvc\r\n    PointsSvc --> NotificationSvc\r\n```\r\n\r\n### Modular Design Principles\r\n- 单文件职责：例如 `listing.controller.ts` 仅处理路由，业务在 `listing.service.ts`，数据访问在 `listing.repository.ts`。\r\n- 组件隔离：前端将“发布表单”“搜索输入”“成交反馈弹窗”等拆分独立组件，利于复用。\r\n- 服务层分离：Auth/Points/Search 等不直接调用彼此数据库，全部通过 API/事件交互。\r\n- 工具模块化：加密、拼音匹配、剪贴板封装为 `/shared/utils/*`。\r\n\r\n## Components and Interfaces\r\n\r\n### Auth Service\r\n- **Purpose:** 管理微信OAuth、手机号绑定、登录 JWT。\r\n- **Interfaces:**\r\n  - `POST /auth/wechat/callback {code,state}` → 返回临时token。\r\n  - `POST /auth/bind-phone {tempToken, phone, smsCode}` → 绑定并返回JWT。\r\n  - `GET /auth/profile` → 返回绑定状态与设备指纹。\r\n- **Dependencies:** 微信开放平台、短信服务、`users`表。\r\n- **Reuses:** 现有短信验证码、JWT模块。\r\n\r\n### Listing Service\r\n- **Purpose:** 发布信息、扣积分、自动复制、有效期管理、重新上架。\r\n- **Interfaces:**\r\n  - `POST /posts`（包含AI辅助字段）\r\n  - `POST /posts/:id/contact`（扣1积分并返回微信号）\r\n  - `POST /posts/:id/republish`\r\n  - `GET /posts?filters...`\r\n- **Dependencies:** Points Service、AI Gateway、Deal Service（事件）、Search Service（索引更新）。\r\n- **Reuses:** 既有帖子模型、通知中心。\r\n\r\n### Deal Service\r\n- **Purpose:** 处理成交反馈、累计成交次数、提醒未反馈用户。\r\n- **Interfaces:**\r\n  - `POST /deals/:contactId/confirm`\r\n  - `POST /deals/:contactId/remind`\r\n  - 事件监听：`ContactViewed`、`DealConfirmed`\r\n- **Dependencies:** Posts/Users 表、Notification Service。\r\n\r\n### Search Service\r\n- **Purpose:** 提供统一搜索API，含模糊/拼音/历史/热门词。\r\n- **Interfaces:**\r\n  - `GET /search?q=...&filters...`\r\n  - `GET /search/history`\r\n  - `DELETE /search/history`\r\n  - `GET /search/hints`\r\n- **Dependencies:** ElasticSearch、User Service（历史同步）、运营配置服务。\r\n\r\n### Points Service\r\n- **Purpose:** 积分账本、充值审核、提醒。\r\n- **Interfaces:**\r\n  - `POST /points/consume`\r\n  - `POST /points/recharge-request`\r\n  - `POST /admin/points/recharge/:id/approve`\r\n  - Webhook/事件：`RechargeTimeout`\r\n- **Dependencies:** Notification、Admin 前端。\r\n\r\n### AI Gateway\r\n- **Purpose:** 封装 DeepSeek API，提供超时/熔断/日志。\r\n- **Interfaces:**\r\n  - `POST /ai/listing-extract {title, description}`\r\n- **Dependencies:** DeepSeek HTTP API。\r\n\r\n## Data Models\r\n\r\n### Users\r\n```\r\nusers (\r\n  id BIGINT PK,\r\n  phone VARCHAR(11) UNIQUE,\r\n  wechat_openid VARCHAR(64) UNIQUE,\r\n  wechat_unionid VARCHAR(64) NULL,\r\n  device_fingerprint VARCHAR(128) NULL,\r\n  total_deals INT DEFAULT 0,\r\n  points INT DEFAULT 100,\r\n  status TINYINT DEFAULT 1,\r\n  created_at/updated_at TIMESTAMP\r\n)\r\n```\r\n\r\n### Posts\r\n```\r\nposts (\r\n  id BIGINT PK,\r\n  user_id BIGINT,\r\n  title VARCHAR(100),\r\n  keywords VARCHAR(200),\r\n  price DECIMAL(10,2),\r\n  trade_type TINYINT,\r\n  description TEXT,\r\n  remaining_views INT DEFAULT 10,\r\n  total_deals INT DEFAULT 0,\r\n  status TINYINT DEFAULT 1,\r\n  expire_at DATETIME,\r\n  view_count INT,\r\n  created_at/updated_at\r\n)\r\n```\r\n\r\n### Contact Views\r\n```\r\ncontact_views (\r\n  id BIGINT PK,\r\n  post_id BIGINT,\r\n  buyer_id BIGINT,\r\n  seller_id BIGINT,\r\n  deducted_points INT,\r\n  copied BOOLEAN,\r\n  copied_at DATETIME,\r\n  confirm_status TINYINT DEFAULT 0,\r\n  confirm_payload JSON,\r\n  confirm_deadline DATETIME,\r\n  created_at\r\n)\r\n```\r\n\r\n### Point Transactions\r\n```\r\npoint_transactions (\r\n  id BIGINT PK,\r\n  user_id BIGINT,\r\n  change_type ENUM('publish','view','republish','recharge','bonus'),\r\n  amount INT,\r\n  balance_after INT,\r\n  related_id BIGINT,\r\n  description VARCHAR(200),\r\n  created_at\r\n)\r\n```\r\n\r\n### Recharge Tasks\r\n```\r\nrecharge_tasks (\r\n  id BIGINT PK,\r\n  user_id BIGINT,\r\n  amount INT,\r\n  voucher_url VARCHAR(255),\r\n  status ENUM('pending','approved','rejected','timeout'),\r\n  assigned_admin BIGINT NULL,\r\n  remind_count INT DEFAULT 0,\r\n  created_at, updated_at\r\n)\r\n```\r\n\r\n### Search History\r\n```\r\nsearch_history (\r\n  id BIGINT PK,\r\n  user_id BIGINT,\r\n  keyword VARCHAR(100),\r\n  source ENUM('manual','suggestion'),\r\n  created_at,\r\n  UNIQUE(user_id, keyword)\r\n)\r\n```\r\n\r\n## Error Handling\r\n\r\n1. **微信授权失败/超时**\r\n   - Handling: 返回错误码+重试链接，记录失败次数，超过阈值触发告警。\r\n   - User Impact: Toast“授权失败，请重试或稍后再试”。\r\n\r\n2. **积分扣减失败**\r\n   - Handling: 回滚发布/查看动作，记录审计日志；如果是服务不可用，进入补偿队列重试。\r\n   - User Impact: 提示“积分扣减失败，稍后再试，未扣款”。\r\n\r\n3. **AI 服务超时/异常**\r\n   - Handling: 返回默认提示“请手动填写”，并记录error+降级策略；熔断期间直接跳过AI调用。\r\n   - User Impact: 表单显示“AI暂不可用，请手动填写”。\r\n\r\n4. **充值审核超时**\r\n   - Handling: 定时任务扫描 pending>30min 的记录，发送二次提醒并在后台待办页高亮。\r\n   - User Impact: 用户端显示“正在加急处理，请稍候”，并可联系客服。\r\n\r\n## Testing Strategy\r\n\r\n### Unit Testing\r\n- Auth 服务：微信回调校验、绑定逻辑、JWT 生成。\r\n- Listing 服务：表单校验、积分扣减、自动复制失败重试、重新上架逻辑。\r\n- Deal 服务：累计成交计数、提醒调度、事件监听。\r\n- Search 服务：关键词/拼音匹配器、历史存储与裁剪。\r\n- Points 服务：记账幂等、充值提醒调度。\r\n- AI Gateway：超时/重试/熔断策略。\r\n\r\n### Integration Testing\r\n- “发布→扣积分→写索引→AI辅助日志”闭环测试。\r\n- “查看联系方式→扣积分→写 contact_views → Deal 提醒”流程。\r\n- “充值请求→后台审批→积分到账+通知”流程。\r\n- “搜索输入→历史记录→后台热门词配置”整体链路。\r\n\r\n### End-to-End Testing\r\n- 用户首次注册并发布、他人查看、双方确认成交、累计次数在列表展示。\r\n- 用户多次搜索（含拼音/模糊）并清空历史。\r\n- 用户提交充值，后台管理员在提醒列表中审批，用户端收到积分到账提示。\r\n- DeepSeek 服务不可用时的降级体验验证。\r\n",
  "fileStats": {
    "size": 9847,
    "lines": 248,
    "lastModified": "2025-11-19T10:41:34.366Z"
  },
  "comments": []
}